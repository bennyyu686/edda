===============================
5. Building transcript families
===============================

Install khmer, screed, and BLAST.  (See :doc:`1-quality` and
:doc:`installing-blastkit`).  I would suggest using an m1.large or
m1.xlarge machine.

You'll also need to install some eel-pond scripts::

   git clone https://github.com/ctb/eel-pond.git /usr/local/share/eel-pond

Copy in your data
=================

You need to get ahold of your assembled transcriptome (from
e.g. :doc:`3-big-assembly`).  Put it in /mnt.

For the purposes of your first run through, I suggest just grabbing my copy
of the Nematostella assembly::

   cd /mnt
   curl -O https://s3.amazonaws.com/public.ged.msu.edu/trinity-nematostella-raw.fa.gz

Run khmer partitioning
======================

Partitioning runs a de Bruijn graph-based clustering algorithm that will
cluster your transcripts by transitive sequence overlap.  That is, it will
build transcript families :). ::

   /usr/local/share/khmer/scripts/do-partition.py -x 1e9 -N 4 --threads 4 nema trinity-nematostella-raw.fa.gz

This should take about 15 minutes, and outputs a file ending in '.part'
that contains the partition assignments.  Now, group and rename the
sequences::

   python /usr/local/share/eel-pond/rename-with-partitions.py nema trinity-nematostella-raw.fa.gz.part
   mv trinity-nematostella-raw.fa.gz.part.renamed.fasta.gz trinity-nematostella.renamed.fa.gz

.. tail n.dist
.. (warning)

.. 

.. (explain sequence names)

Looking at the renamed sequences
================================

Let's look at the renamed sequences::

   gunzip -c trinity-nematostella.renamed.fa.gz | head

You'll see that each sequence name looks like this::

   >nema.id1.tr16001 1_of_1_in_tr16001 len=261 id=1 tr=16001

Some explanation:

 - 'nema' is the prefix that you gave the rename script, above;

 - 'idN' is the unique ID for this sequence; it will never be repeated in this
   file.

 - 'trN' is the transcript family, which may contain one or more transcripts.

 - '1_of_1_in_tr16001' tells you that this transcript family has only
   one transcript in it (this one!) Other transcript families may
   (will) have more.

 - 'len' is the sequence length.

Doing a preliminary annotation against mouse
============================================

Now let's assign putative homology & orthology to these transcripts, by
doing BLASTs & reciprocal best hit analysis.  First, uncompress your
transcripts file::

   gunzip trinity-nematostella.renamed.fa.gz 

Now, grab the latest mouse RefSeq::

   curl -O ftp://ftp.ncbi.nih.gov/refseq/M_musculus/mRNA_Prot/mouse.protein.faa.gz
   gunzip mouse.protein.faa.gz

Format both as BLAST databases::

   formatdb -i mouse.protein.faa -o T -p T
   formatdb -i trinity-nematostella.renamed.fa -o T -p F

And, now, run BLAST in both directions.  Note, this may take ~24 hours or
longer; you probably want to run it in screen::

   blastall -i trinity-nematostella.renamed.fa -d mouse.protein.faa -e 1e-3 -p blastx -o nema.x.mouse -a 8
   blastall -i mouse.protein.faa -d trinity-nematostella.renamed.fa -e 1e-3 -p tblastn -o mouse.x.nema -a 8
